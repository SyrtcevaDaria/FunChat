(()=>{"use strict";var e,t;!function(e){e.MSG_FROM_USER="MSG_FROM_USER",e.USER_LOGOUT="USER_LOGOUT",e.USER_LOGIN="USER_LOGIN",e.USER_EXTERNAL_LOGIN="USER_EXTERNAL_LOGIN",e.USER_EXTERNAL_LOGOUT="USER_EXTERNAL_LOGOUT",e.USER_ACTIVE="USER_ACTIVE",e.USER_INACTIVE="USER_INACTIVE",e.MSG_SEND="MSG_SEND",e.MSG_READ="MSG_READ",e.MSG_DELIVER="MSG_DELIVER",e.MSG_DELETE="MSG_DELETE",e.MSG_EDIT="MSG_EDIT",e.ERROR="ERROR"}(e||(e={})),function(e){e[e.USERNAME=0]="USERNAME",e[e.PASSWORD=1]="PASSWORD"}(t||(t={}));class s{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onClick",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"disabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"classList",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.onClick=e.onClick,this.disabled=e.disabled,this.classList=e.classList}render(){const e=document.createElement("button");return e.textContent=this.text,this.classList.forEach((t=>{e.classList.add(`${t}`)})),e.addEventListener("click",(e=>{this.onClick(e)})),this.disabled&&(e.disabled=!0),e}}class i{constructor(e){Object.defineProperty(this,"placeholder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"classList",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onChange",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"disabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e.placeholder&&(this.placeholder=e.placeholder),e.value&&(this.value=e.value),e.disabled&&(this.disabled=e.disabled),e.onChange&&(this.onChange=e.onChange),this.classList=e.classList,this.type=e.type}render(){const e=document.createElement("input");return this.placeholder&&(e.placeholder=this.placeholder),this.value&&(e.value=this.value),this.disabled&&(e.disabled=this.disabled),e.type=this.type,this.classList.forEach((t=>{e.classList.add(t)})),this.onChange&&e.addEventListener("input",(e=>{const{value:t}=e.target;this.onChange&&this.onChange(t)})),e}}class n{constructor({classList:e,tagName:t="div",textContent:s="",href:i="https://github.com/SyrtcevaDaria",src:n="",alt:a="",onClick:r=null}){Object.defineProperty(this,"element",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.element=document.createElement(t),this.element.textContent=s,r&&this.element.addEventListener("click",(e=>{r(e)})),this.element instanceof HTMLAnchorElement&&(this.element.href=i),this.element instanceof HTMLImageElement&&(this.element.src=n,this.element.alt=a),this.classList(e),this.render()}classList(e){this.element.classList.add(...e)}render(){return this.element}}class a{constructor(e){Object.defineProperty(this,"modalWrap",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.modalWrap=new n({classList:["modal-wrap"]}).render(),this.modalWrap.append(new n({tagName:"p",classList:["modal-text"],textContent:e.txt}).render()),this.modalWrap.append(new s({text:"Ok",classList:["button","button_modal"],onClick:()=>e.onClickModal()}).render())}render(){return this.modalWrap}}class r{constructor(e){Object.defineProperty(this,"usernameInput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"passwordInput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"usernamePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"passwordPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"loginButton",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"infoButton",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"loginPage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modal",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"handleEnter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"container",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.loginPage=e,this.container=new n({classList:["container","login-container"]}).render(),this.usernamePrompt=new n({classList:["prompt_username"],textContent:"The name must contain only letters of the Latin alphabet and -\nEnter a maximum of 10 characters",tagName:"p"}).render(),this.passwordPrompt=new n({classList:["prompt_password"],textContent:"he password must be more than 5 characters long"}).render(),this.usernameInput=new i({placeholder:"Username",classList:["input","input_username"],type:"text",onChange:()=>this.usernameChange()}).render(),this.passwordInput=new i({placeholder:"Password",classList:["input","input_password"],type:"password",onChange:()=>this.passwordChange()}).render(),this.loginButton=new s({text:"Login",classList:["button","button_login"],disabled:!0,onClick:e=>this.handleLogin(e)}).render(),this.infoButton=new s({text:"Info",classList:["button","button_info"],disabled:!1,onClick:()=>this.handleInfo()}).render(),this.handleEnter=e=>{"Enter"===e.key&&this.loginPage.handlePressEnter(this.usernameInput.value,this.passwordInput.value)},this.addListeners(),this.render()}usernameChange(){this.loginPage.handlerUsernameInput(this.usernameInput.value)}passwordChange(){this.loginPage.handlerPasswordInput(this.passwordInput.value)}addListeners(){document.body.addEventListener("keypress",this.handleEnter)}removeListeners(){document.body.removeEventListener("keypress",this.handleEnter)}handleLogin(e){e.preventDefault();const t=this.usernameInput.value,s=this.passwordInput.value;this.loginPage.handleLogin(t,s)}handleInfo(){this.loginPage.handleClickInfo()}handleInvalidData(e){switch(e){case t.PASSWORD:this.passwordPrompt.classList.add("active"),this.passwordInput.classList.add("error");break;case t.USERNAME:this.usernameInput.classList.add("error"),this.usernamePrompt.classList.add("active")}this.loginButton.disabled=!0}handleValidData(e){switch(e){case t.PASSWORD:this.passwordPrompt.classList.remove("active"),this.passwordInput.classList.remove("error");break;case t.USERNAME:this.usernamePrompt.classList.remove("active"),this.usernameInput.classList.remove("error")}}render(){document.body.innerHTML="";const e=new n({classList:["login-form"]}).render(),t=new n({classList:["button-wrap"]}).render(),s=new n({classList:["input-wrap"]}).render(),i=new n({classList:["username-wrap"]}).render(),a=new n({classList:["password-wrap"]}).render(),r=new n({classList:["login-title"],tagName:"h3",textContent:"Authorization"}).render();i.append(this.usernameInput,this.usernamePrompt),a.append(this.passwordInput,this.passwordPrompt),s.append(i,a),t.append(this.loginButton,this.infoButton),e.append(r,s,t),this.container.appendChild(e),document.body.appendChild(this.container)}createModal(e){const t=new n({classList:["overlay"]}).render();t.append(new a({txt:e,onClickModal:()=>t.remove()}).render()),this.container.append(t)}}class o{static setUsername(e){sessionStorage.setItem(o.KEY_USERNAME,e)}static setPassword(e){sessionStorage.setItem(o.KEY_PASSWORD,e)}static getUsername(){return sessionStorage.getItem(o.KEY_USERNAME)}static getPassword(){return sessionStorage.getItem(o.KEY_PASSWORD)}}Object.defineProperty(o,"KEY_USERNAME",{enumerable:!0,configurable:!0,writable:!0,value:"username"}),Object.defineProperty(o,"KEY_PASSWORD",{enumerable:!0,configurable:!0,writable:!0,value:"password"});const l=o;class c{constructor(e,t){Object.defineProperty(this,"LoginView",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isValidUsername",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"isValidPassword",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"router",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"socket",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"minPasswordLength",{enumerable:!0,configurable:!0,writable:!0,value:6}),Object.defineProperty(this,"maxUsernameLength",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(this,"indexUsernameInData",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"indexPasswordInData",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(this,"delimiter",{enumerable:!0,configurable:!0,writable:!0,value:"-"}),this.clearStorage(),this.router=e,this.LoginView=new r(this),this.socket=t,this.socket.setupSocketCallbacks({onLogin:this.getAnswerFromSocket.bind(this)})}clearStorage(){l.setPassword(""),l.setUsername("")}handlerPasswordInput(e){e.length>=this.minPasswordLength&&!e.includes(" ")||0===e.length?(this.LoginView.handleValidData(t.PASSWORD),this.isValidPassword=e.length>0):(this.isValidPassword=!1,this.LoginView.handleInvalidData(t.PASSWORD)),this.checkValid()}handlerUsernameInput(e){/^[a-zA-Z_-]+$/.test(e)&&e.length<this.maxUsernameLength||0===e.length?(this.LoginView.handleValidData(t.USERNAME),this.isValidUsername=e.length>0):(this.isValidPassword=!1,this.LoginView.handleInvalidData(t.USERNAME)),this.checkValid()}checkValid(){this.isValidPassword&&this.isValidUsername?this.LoginView.loginButton.disabled=!1:this.LoginView.loginButton.disabled=!0}handleLogin(e,t){this.socket.handleLogin(e,t)}handlePressEnter(e,t){this.isValidPassword&&this.isValidUsername&&this.handleLogin(e,t)}getAnswerFromSocket(e){this.LoginView.removeListeners(),"user"in e.payload&&this.router.navigate(b.MAIN,e.id.split(this.delimiter)[this.indexUsernameInData],e.id.split(this.delimiter)[this.indexPasswordInData])}handleClickInfo(){this.router.navigate(b.INFO)}}class d{constructor(e){Object.defineProperty(this,"backButton",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"infoPage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.infoPage=e,this.backButton=new s({text:"Back",classList:["button","button_back"],onClick:()=>this.handleBack()}).render(),this.render()}handleBack(){window.history.back()}render(){document.body.innerHTML="";const e=new n({classList:["container","info-container"]}).render(),t=new n({classList:["info-wrap"]}).render(),s=new n({classList:["info-title"],tagName:"h3",textContent:"Fun Chat"}).render(),i=new n({classList:["desctiption"],textContent:"This fun chat was created for the purpose of learning."}).render(),a=new n({tagName:"a",classList:["author-link"],textContent:"Author - SyrtcevaDaria",href:"https://github.com/SyrtcevaDaria"}).render();t.append(s,i,a,this.backButton),e.appendChild(t),document.body.appendChild(e)}}class h{constructor(){Object.defineProperty(this,"InfoView",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.InfoView=new d(this)}render(){const e=document.createElement("div");e.classList.add("info"),document.body.appendChild(e)}}var u,g,b;!function(e){e.EDITED="edited",e.READ="read",e.DELEVERED="delivered",e.EMPTY=""}(u||(u={}));class p{constructor(e){Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onDelete",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onEdit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"username",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.time=e.changeTimeFormat,this.message=e.message,this.onDelete=e.onDelete,this.onEdit=e.onEdit,this.username=e.username}renderButtonsContainer(){const e=new n({classList:["button-cont"]}).render(),t=new s({text:"delete",onClick:()=>this.onDelete(this.message.id,this.message.from,this.message.to),classList:["delete-button","message-button"]}).render(),i=new s({text:"edit",onClick:()=>this.onEdit(this.message),classList:["edit-button","message-button"]}).render();return e.append(t,i),e}render(){const e=new n({classList:["message",`${this.message.id}`]}).render();this.username===this.message.from?e.classList.add("left"):e.classList.add("right");const t=new n({classList:["message-header"]}).render(),s=new n({classList:["message-sender"],textContent:this.message.from}).render(),i=new n({classList:["message-time"],textContent:this.time}).render();t.append(s,i);const a=new n({classList:["message-text"],textContent:this.message.text}).render(),r=new n({classList:["message-footer"]}).render();if(e.classList.contains("right")){const e=new n({classList:["status"],textContent:this.putStatus(this.message.status)}).render(),t=new n({tagName:"span",classList:["change-status","status"],textContent:this.putChangeStatus(this.message.status)}).render();r.append(this.renderButtonsContainer(),t,e)}else{const e=new n({tagName:"span",classList:["change-status","status"],textContent:this.putChangeStatus(this.message.status)}).render();r.append(e)}return e.append(t,a,r),e}putChangeStatus(e){return e.isEdited?u.EDITED:""}putStatus(e){return e.isReaded?u.READ:e.isDelivered?u.DELEVERED:u.EMPTY}}!function(e){e.online=".user-list-online",e.offline=".user-list-offline"}(g||(g={}));class m{constructor(e,t){Object.defineProperty(this,"MainPage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"username",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"userOnlineList",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"userOfflineList",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"searchElem",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"interlocutorName",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"interlocutorStatus",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"messageHistory",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"inputField",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"sendButton",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"onlineUserList",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"offlineUserList",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"messageList",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"nameInterlocutor",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"unreadStructure",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"delimiter",{enumerable:!0,configurable:!0,writable:!0,value:"-"}),Object.defineProperty(this,"indexInSelectorOfIndicator",{enumerable:!0,configurable:!0,writable:!0,value:2}),document.body.addEventListener("keypress",(e=>{"Enter"===e.key&&!1===this.sendButton?.disabled&&this.sendMessage()})),this.MainPage=e,this.username=t,this.username&&(this.render(),this.setupSocket())}setupSocket(){const e=this.addOnlineUser.bind(this),t=this.addOfflineUser.bind(this),s=this.updateOnlineUsers.bind(this),i=this.updateInactiveUsers.bind(this),n=this.updateMessageHistory.bind(this),a=this.addMessage.bind(this);this.MainPage.socket.setupSocketCallbacks({onExternalLogin:e,onExternalLogout:t,onActiveUsersUpdate:s,onInactiveUsersUpdate:i,onMessageHistory:n,onSend:a,onDeliver:this.onDeliver.bind(this),onRead:this.onRead.bind(this),onDelete:this.onDelete.bind(this),onEdit:this.onEdit.bind(this)})}renderHeader(){const e=new n({classList:["header"]}).render(),t=new n({classList:["username"],textContent:`Username: ${this.username}`}).render(),i=new n({classList:["chatName"],textContent:"Fun Chat"}).render(),a=new n({classList:["buttons-block"]}).render(),r=new s({classList:["button","info-button"],text:"info",onClick:()=>this.clickInfo()}).render(),o=new s({classList:["button","logout-button"],text:"logout",onClick:()=>this.clickLogout()}).render();return a.append(r,o),e.append(t,i,a),e}renderMain(){const e=new n({classList:["main"]}).render(),t=this.renderUserList(),s=this.renderMessageBlock();return e.append(t,s),e}renderMessageBlock(){const e=new n({classList:["wrap-message-block"]}).render(),t=new n({classList:["messages-header"]}).render();this.interlocutorName=new n({classList:["interlocutor-name"],textContent:""}).render(),this.interlocutorStatus=new n({classList:["interlocutor-status"],textContent:""}).render(),this.messageHistory=new n({classList:["message-block","nothing"],textContent:"Select a user to send a message"}).render(),this.messageHistory.scrollTop=this.messageHistory.scrollHeight-this.messageHistory.clientHeight;const a=new n({classList:["messages-footer"]}).render();return this.inputField=new i({classList:["input-field"],placeholder:"Message...",type:"text",onChange:()=>this.changeInput(),disabled:!0}).render(),this.sendButton=new s({classList:["send-button","button"],text:"Send",onClick:()=>this.sendMessage(),disabled:!0}).render(),t.append(this.interlocutorName,this.interlocutorStatus),a.append(this.inputField,this.sendButton),e.append(t,this.messageHistory,a),e}updateMessageHistory(e){this.messageList=e.payload.messages,this.updateMessageHistoryView()}onDelete(e){document.querySelectorAll(".message").forEach((t=>{t.classList.contains(`${e.payload.message.id}`)&&t.remove()})),this.messageList=this.messageList.filter((t=>t.id!==e.payload.message.id)),this.updateMessageHistoryView()}onRead(e){this.messageList.forEach(((t,s)=>{e.payload.message.id===t.id&&(this.messageList[s].status.isReaded=e.payload.message.status.isReaded)})),this.updateMessageHistoryView()}sendMessage(){const e=l.getUsername();e&&this.inputField&&this.interlocutorName&&this.interlocutorName.textContent&&this.MainPage.socket.sendMessage(e,this.interlocutorName.textContent,this.inputField.value);const t=document.querySelector(".input-field");t instanceof HTMLInputElement&&(t.value="",this.changeInput())}changeInput(){""!==this.inputField?.value&&this.sendButton?this.sendButton.disabled=!1:this.sendButton&&(this.sendButton.disabled=!0)}updateOnlineUsers(e){this.onlineUserList=[...e],this.onlineUserList.forEach((e=>{e.login!==l.getUsername()&&this.MainPage.socket.reciveMessageHistory(e.login)})),this.renderList(g.online,this.onlineUserList)}renderList(e,t){const s=t.filter(((e,t,s)=>t===s.findIndex((t=>t.login===e.login))&&e.login!==this.MainPage.socket.username)),i=document.querySelector(e);i&&(i.innerHTML="",s.forEach((t=>{if(this.MainPage.socket.username!==t.login&&t.login){const s=new n({classList:["user-list_li",`${e.split(this.delimiter)[this.indexInSelectorOfIndicator]}`],tagName:"li"}).render(),a=new n({classList:["indicator"],tagName:"span"}).render(),r=new n({classList:[`username-${e.split(this.delimiter)[this.indexInSelectorOfIndicator]}`,"username"],tagName:"span",textContent:`${t.login}`}).render(),o=new n({classList:["unread-message"],tagName:"span",textContent:""}).render();s.append(a,r,o),i.append(s)}})))}updateInactiveUsers(e){this.offlineUserList=[...e],this.offlineUserList.forEach((e=>{e.login!==l.getUsername()&&this.MainPage.socket.reciveMessageHistory(e.login)})),this.renderList(g.offline,this.offlineUserList)}addOnlineUser(e){const t=document.querySelector(".interlocutor-name");if(t&&t.textContent===e.login){const e=document.querySelector(".interlocutor-status");e&&(e.textContent="online")}this.offlineUserList=this.offlineUserList.filter((t=>t.login!==e.login));const s={login:e.login,isLogined:e.isLogined};e.login&&(this.onlineUserList=[...this.onlineUserList,s]),this.renderList(g.online,this.onlineUserList),this.renderList(g.offline,this.offlineUserList)}addOfflineUser(e){const t=document.querySelector(".interlocutor-name");if(t&&t.textContent===e.login){const e=document.querySelector(".interlocutor-status");e&&(e.textContent="offline")}this.onlineUserList=this.onlineUserList.filter((t=>t.login!==e.login)),this.offlineUserList.push(e),this.renderList(g.online,this.onlineUserList),this.renderList(g.offline,this.offlineUserList)}renderUserList(){const e=new n({classList:["wrap-user-list"]}).render();this.searchElem=new i({placeholder:"Search...",classList:["search-elem"],onChange:()=>this.changeSearch(),type:"text"}).render();const t=new n({classList:["user-list-online"],tagName:"ul",onClick:e=>this.clickUser(e)}).render(),s=new n({classList:["user-list-offline"],tagName:"ul",onClick:e=>this.clickUser(e)}).render();return e.append(this.searchElem),e.append(t),e.append(s),e}clickUser(e){this.inputField&&(this.inputField.disabled=!1);const t=e.target.closest(".user-list_li");if(t){const e=t.querySelector(".username");if(e){const t=e.textContent;this.interlocutorName&&t&&(this.interlocutorName.textContent=t,this.username=t,this.MainPage.socket.reciveMessageHistory(this.interlocutorName.textContent))}this.interlocutorStatus&&(e?.classList.contains("username-online")?this.interlocutorStatus.textContent="online":this.interlocutorStatus.textContent="offline")}}deleteMessage(e){this.MainPage.socket.deleteMessage(e)}createEditWindow(e){const t=new n({classList:["overlay"]}).render(),a=new n({classList:["modal-wrap","edit"]}).render();a.append(new n({tagName:"p",classList:["modal-text"],textContent:"Edit message"}).render());const r=new i({type:"text",value:`${e.text}`,classList:["input","edit-input"]}).render();a.append(r),a.append(new s({onClick:()=>{this.editMessage(r.value,e.id)},text:"Save",disabled:!1,classList:["save-button","button"]}).render()),a.append(new s({onClick:()=>t.remove(),text:"Cancle",disabled:!1,classList:["cancle-button","button"]}).render()),t.append(a),document.body.append(t)}onEdit(e){for(let t=0;t<this.messageList.length;t+=1)this.messageList[t].id===e.payload.message.id&&(this.messageList[t].text=e.payload.message.text,this.messageList[t].status.isEdited=e.payload.message.status.isEdited);this.updateMessageHistoryView()}editMessage(e,t){this.MainPage.socket.editMessage(t,e);const s=document.body.querySelector(".overlay");s&&s.remove()}handleEditClick(e){this.createEditWindow(e)}onDeliver(e){this.messageList.forEach(((t,s)=>{t.id===e.id&&(this.messageList[s].status.isDelivered=e.status.isDelivered)})),this.updateMessageHistoryView()}addListenersReadMessage(e,t){const s=i=>{if(i.isTrusted){t.removeEventListener("click",s);const i=t.querySelector(".line");i&&(t.removeChild(i),this.messageList.length&&this.messageList.forEach((t=>{!t.status.isReaded&&t.from!==l.getUsername()&&e&&this.MainPage.socket.readMessage(t.id,t.from,t.to,!1)})))}};t.addEventListener("click",s)}updateMessageHistoryView(){const e=document.querySelector(".message-block"),t=document.querySelector(".interlocutor-name")?.textContent;if(e&&(e.innerHTML=""),t)if(0===this.messageList.length&&e)e.classList.add("nothing"),e.textContent="Write your first message";else{e?.classList.remove("nothing");let s=!1;this.messageList.forEach((i=>{const a=this.MainPage.changeViewData(i.datetime);if(t){if(!i.status.isReaded&&!s&&l.getUsername()!==i.from){const t=new n({classList:["line"]}).render(),i=new n({classList:["line-text"],textContent:"unread messages"}).render(),a=new n({classList:["line-bar"]}).render(),r=new n({classList:["line-bar"]}).render();t.append(a,i,r),e.append(t),s=!0}const r=new p({message:i,onDelete:()=>this.deleteMessage(i.id),onEdit:()=>this.handleEditClick(i),changeTimeFormat:a,username:t}).render();e&&e.append(r)}})),s?(this.scrollToLine(),this.addListenersReadMessage(document.querySelector(".line"),document.querySelector(".message-block"))):this.scroll()}else e.classList.add("nothing"),e.textContent="Select a user to send a message"}scroll(){const e=document.querySelector(".message-block");e&&e.scrollHeight>e.clientHeight&&(e.scrollTop=e.scrollHeight)}scrollToLine(){const e=document.querySelector(".message-block"),t=document.querySelector(".line");if(e&&t){const s=new Event("scroll",{bubbles:!0,cancelable:!1}),i=e.getBoundingClientRect(),n=t.getBoundingClientRect().top-i.top+e.scrollTop;e.scrollTop=n,e.dispatchEvent(s)}}addMessage(e){if(this.messageList=[...this.messageList,e.payload.message],null!==e.id){const e=document.querySelector(".line");e&&e.remove(),this.messageList.filter((e=>!e.status.isReaded&&e.from!==l.getUsername())).forEach((e=>{this.MainPage.socket.readMessage(e.id,e.from,e.to,!0)}))}this.updateMessageHistoryView()}changeSearch(){const e=document.querySelector(".search-elem");if(e){const t=e.value;if(void 0!==t){const e=this.onlineUserList.filter((e=>e.login.startsWith(t))),s=this.offlineUserList.filter((e=>e.login.startsWith(t)));this.renderList(g.online,e),this.renderList(g.offline,s)}""===t&&(this.renderList(g.online,this.onlineUserList),this.renderList(g.offline,this.offlineUserList))}}renderFooter(){const e=new n({classList:["footer"]}).render(),t=new n({tagName:"a",classList:["school-link","main-page-link"],href:"https://rs.school/"}).render(),s=new n({tagName:"img",classList:["school-logo"],src:"https://raw.githubusercontent.com/rolling-scopes-school/rs.school-site/8dc49e9a90437b68065ec36d19f6d1f80c940a90/docs/images/rs_school_js.svg",alt:"School logo"}).render();t.appendChild(s);const i=new n({tagName:"a",classList:["author-link","main-page-link"],textContent:"SyrtcevaDaria",href:"https://github.com/SyrtcevaDaria"}).render(),a=new n({classList:["year"],textContent:"2024"}).render();return e.append(t,i,a),e}render(){const e=new n({classList:["main-wrap"]}).render(),t=this.renderHeader(),s=this.renderMain(),i=this.renderFooter();e.append(t,s,i),document.body.append(e)}clickLogout(){this.MainPage.handleClickLogout(),l.setUsername(""),l.setPassword("")}clickInfo(){this.MainPage.handleClickInfo()}}class f{constructor(e,t,s,i){Object.defineProperty(this,"MainView",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"router",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"username",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"password",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"socket",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxLength",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(this,"fillString",{enumerable:!0,configurable:!0,writable:!0,value:"0"}),this.socket=e,this.router=t,this.username=s,this.password=i,this.setDataToStorage(),this.socket.setupUser(s,i),this.socket.openMainPage(),this.setupSocket(),this.MainView=new m(this,s)}setDataToStorage(){""!==this.username&&(l.setPassword(this.password),l.setUsername(this.username))}setupSocket(){this.socket.setupSocketCallbacks({onLogout:this.getLogoutAnswer.bind(this)})}handleClickInfo(){this.socket.handleLogout(this.username,this.password,!1),this.router.navigate(b.INFO)}handleClickLogout(){this.socket.handleLogout(this.username,this.password)}getLogoutAnswer(e){"user"in e.payload&&this.socket.username&&this.socket.password&&this.router.navigate(b.LOGIN)}changeViewData(e){const t=new Date(e),s=t.getFullYear(),i=String(t.getMonth()+1).padStart(this.maxLength,this.fillString);return`${String(t.getDate()).padStart(this.maxLength,this.fillString)}.${i}.${s} ${String(t.getHours()).padStart(this.maxLength,this.fillString)}:${String(t.getMinutes()).padStart(this.maxLength,this.fillString)}:${String(t.getSeconds()).padStart(this.maxLength,this.fillString)}`}}!function(e){e.DEFAULT="",e.LOGIN="login",e.INFO="info",e.MAIN="main",e.NOTFOUND="not-found"}(b||(b={}));class L{constructor(e){Object.defineProperty(this,"socket",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"currentPage",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.socket=e;const t=window.location.hash.slice(1);this.navigate(t),this.routeChange()}routeChange(){window.addEventListener("hashchange",(()=>{const e=window.location.hash.slice(1);this.navigate(e)}))}navigate(e,t="",s=""){document.body.innerHTML="";let i="";switch(e){case b.DEFAULT:case b.LOGIN:i=`${window.location.origin}/#${b.LOGIN}`,window.location.href!==i&&window.history.pushState({},"",i),this.currentPage=new c(this,this.socket);break;case b.INFO:i=`${window.location.origin}/#${b.INFO}`,window.location.href.trim()!==i.trim()&&window.history.pushState({},"",i),this.currentPage=new h;break;case b.MAIN:i=`${window.location.origin}/#${b.MAIN}`,window.location.href!==i&&window.history.pushState({},"",i),this.currentPage=new f(this.socket,this,t,s);break;default:this.currentPage=new c(this,this.socket)}}checkURL(e){return window.location.href!==e}}class w{constructor(e){Object.defineProperty(this,"socket",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"username",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"password",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"router",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"delimiter",{enumerable:!0,configurable:!0,writable:!0,value:"-"}),Object.defineProperty(this,"app",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isTrustedIndexInLogoutMessage",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"isTrustedFlagInLogoutMessage",{enumerable:!0,configurable:!0,writable:!0,value:"true"}),this.app=e,this.socket=new WebSocket("ws://localhost:4000"),this.socket.addEventListener("open",(()=>{const e=document.querySelector(".overlay");e&&e.remove(),this.router=new L(this)})),this.socket.addEventListener("close",(()=>{this.renderLoadingWindow(),this.app.socket=null})),this.setupSocket()}renderLoadingWindow(){if(!document.querySelector(".overlay")){const e=new n({classList:["overlay"]}).render(),t=new n({classList:["modal-wrap","edit"]}).render();t.append(new n({tagName:"p",classList:["modal-text"],textContent:"Loading..."}).render()),e.append(t),document.body.append(e)}}openMainPage(){if(""===this.username){const e=l.getUsername(),t=l.getPassword();e&&t&&(this.username=e,this.password=t,this.reLogin(e,t))}else this.getOnlineUsers(),this.getNonOnlineUsers()}setupUser(e,t){this.username=e,this.password=t}setupSocketCallbacks(e){e.onActiveUsersUpdate&&void 0===this.callbacks.onActiveUsersUpdate&&(this.callbacks.onActiveUsersUpdate=e.onActiveUsersUpdate),e.onExternalLogin&&void 0===this.callbacks.onExternalLogin&&(this.callbacks.onExternalLogin=e.onExternalLogin),e.onExternalLogout&&void 0===this.callbacks.onExternalLogout&&(this.callbacks.onExternalLogout=e.onExternalLogout),e.onInactiveUsersUpdate&&void 0===this.callbacks.onInactiveUsersUpdate&&(this.callbacks.onInactiveUsersUpdate=e.onInactiveUsersUpdate),e.onLogin&&void 0===this.callbacks.onLogin&&(this.callbacks.onLogin=e.onLogin),e.onLogout&&void 0===this.callbacks.onLogout&&(this.callbacks.onLogout=e.onLogout),e.onMessageHistory&&void 0===this.callbacks.onMessageHistory&&(this.callbacks.onMessageHistory=e.onMessageHistory),e.onSend&&void 0===this.callbacks.onSend&&(this.callbacks.onSend=e.onSend),e.onDeliver&&void 0===this.callbacks.onDeliver&&(this.callbacks.onDeliver=e.onDeliver),e.onRead&&void 0===this.callbacks.onRead&&(this.callbacks.onRead=e.onRead),e.onDelete&&void 0===this.callbacks.onDelete&&(this.callbacks.onDelete=e.onDelete),e.onEdit&&void 0===this.callbacks.onEdit&&(this.callbacks.onEdit=e.onEdit)}setupSocket(){this.socket&&this.socket.addEventListener("message",(t=>{const s=JSON.parse(t.data);switch(s.type){case e.USER_LOGOUT:s.id.split(this.delimiter)[this.isTrustedIndexInLogoutMessage]===this.isTrustedFlagInLogoutMessage&&this.callbacks.onLogout&&this.callbacks.onLogout(s);break;case e.USER_LOGIN:this.callbacks.onLogin?this.callbacks.onLogin(s):this.router&&this.router.navigate(b.MAIN,this.username,this.password);break;case e.USER_EXTERNAL_LOGIN:this.callbacks.onExternalLogin&&"payload"in s&&"user"in s.payload&&this.callbacks.onExternalLogin(s.payload.user);break;case e.USER_EXTERNAL_LOGOUT:this.callbacks.onExternalLogout&&"payload"in s&&"user"in s.payload&&this.callbacks.onExternalLogout(s.payload.user);break;case e.USER_ACTIVE:this.callbacks.onActiveUsersUpdate&&"payload"in s&&"users"in s.payload&&this.callbacks.onActiveUsersUpdate(s.payload.users);break;case e.USER_INACTIVE:this.callbacks.onInactiveUsersUpdate&&"payload"in s&&"users"in s.payload&&this.callbacks.onInactiveUsersUpdate(s.payload.users);break;case e.MSG_FROM_USER:this.callbacks.onMessageHistory&&this.callbacks.onMessageHistory(s);break;case e.MSG_SEND:this.callbacks.onSend&&this.callbacks.onSend(s);break;case e.MSG_READ:this.callbacks.onRead&&this.callbacks.onRead(s);break;case e.MSG_DELIVER:this.callbacks.onDeliver&&"payload"in s&&"message"in s.payload&&this.callbacks.onDeliver(s.payload.message);break;case e.MSG_DELETE:this.callbacks.onDelete&&this.callbacks.onDelete(s);break;case e.MSG_EDIT:this.callbacks.onEdit&&this.callbacks.onEdit(s);break;case e.ERROR:if("error"in s.payload){const e=new n({classList:["overlay"]}).render();e.append(new a({txt:s.payload.error,onClickModal:()=>e.remove()}).render()),document.body.append(e)}}}))}handleLogout(t,s,i=!0){const n={id:`login-${t}-${s}-${i}`,type:e.USER_LOGOUT,payload:{user:{login:t,password:s}}};this.socket&&this.socket.send(JSON.stringify(n))}readMessage(t,s,i,n){const a={id:`read-${t}-${s}-${i}-${n}`,type:e.MSG_READ,payload:{message:{id:`${t}`}}};this.socket&&this.socket.send(JSON.stringify(a))}sendMessage(t,s,i){const n={id:`send-${t}-${s}-${i}`,type:e.MSG_SEND,payload:{message:{to:s,text:i}}};this.socket&&this.socket.send(JSON.stringify(n))}reciveMessageHistory(t){const s={id:`history-${t}`,type:e.MSG_FROM_USER,payload:{user:{login:t}}};this.socket&&this.socket.send(JSON.stringify(s))}reLogin(t,s){const i={id:`login-${t}-${s}`,type:e.USER_LOGIN,payload:{user:{login:t,password:s}}};this.socket&&this.socket.send(JSON.stringify(i))}getOnlineUsers(){const t={id:e.USER_ACTIVE,type:e.USER_ACTIVE,payload:null};this.socket&&this.socket.send(JSON.stringify(t))}getNonOnlineUsers(){const t={id:e.USER_INACTIVE,type:e.USER_INACTIVE,payload:null};this.socket&&this.socket.send(JSON.stringify(t))}handleLogin(t,s){const i={id:`login-${t}-${s}`,type:e.USER_LOGIN,payload:{user:{login:t,password:s}}};this.socket&&this.socket.send(JSON.stringify(i))}deleteMessage(t){const s={id:e.MSG_DELETE,type:e.MSG_DELETE,payload:{message:{id:t}}};this.socket&&this.socket.send(JSON.stringify(s))}editMessage(t,s){const i={id:e.MSG_EDIT,type:e.MSG_EDIT,payload:{message:{id:t,text:s}}};this.socket&&this.socket.send(JSON.stringify(i))}}(new class{constructor(){Object.defineProperty(this,"socket",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultTimeDelay",{enumerable:!0,configurable:!0,writable:!0,value:1e3}),this.socket=null}start(){setInterval((()=>{this.socket||(this.socket=new w(this))}),this.defaultTimeDelay)}}).start()})();